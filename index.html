<!DOCTYPE html>
<html>
<head>
  <title>スマホ傾き + 首前傾Z計測</title>
  <style>
    body {
      font-size: 24px;
      text-align: center;
      padding: 1em;
    }
    video, canvas {
      width: 360px;
      height: 640px;
      transform: scaleX(-1); /* 自撮り用ミラー表示 */
      border: 1px solid gray;
    }
    #startBtn {
      font-size: 24px;
      padding: 10px 20px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>姿勢モニタ（Z座標による前傾）</h1>
  <button id="startBtn" style="display: none;">センサー取得開始</button>
  <p id="output">読み取り中...</p>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>

  <!-- MediaPipe FaceMesh -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script>
    const output = document.getElementById('output');
    const btn = document.getElementById('startBtn');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let pitch = null;
    let dz = null;

    // センサーの取得
    function startOrientation() {
      window.addEventListener('deviceorientation', (event) => {
        pitch = event.beta;
      });
    }

    // MediaPipe FaceMeshの設定
    const faceMesh = new FaceMesh({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
    });
    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    faceMesh.onResults((results) => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

      if (results.multiFaceLandmarks.length > 0) {
        const landmarks = results.multiFaceLandmarks[0];
        const noseZ = landmarks[1].z;
        const chinZ = landmarks[152].z;
        dz = chinZ - noseZ;

        const dzStr = dz.toFixed(4);
        const pitchStr = pitch !== null ? pitch.toFixed(2) : "未取得";

        output.textContent =
          `スマホ傾き(Pitch): ${pitchStr}° / 首前傾Z差(dz): ${dzStr}`;
      } else {
        output.textContent = "顔が検出されていません。";
      }
    });

    async function init() {
      await navigator.mediaDevices.getUserMedia({ video: true });
      const camera = new Camera(video, {
        onFrame: async () => {
          await faceMesh.send({ image: video });
        },
        width: 360,
        height: 640
      });
      camera.start();
      startOrientation();
    }

    function setup() {
      if (
        typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function'
      ) {
        btn.style.display = 'inline-block';
        btn.onclick = () => {
          DeviceOrientationEvent.requestPermission().then(response => {
            if (response === 'granted') {
              startOrientation();
              btn.style.display = 'none';
              init();
            } else {
              output.textContent = 'センサーの許可が拒否されました。';
            }
          }).catch(() => {
            output.textContent = 'センサー許可エラー。';
          });
        };
      } else {
        init();
      }
    }

    window.onload = setup;
  </script>
</body>
</html>
